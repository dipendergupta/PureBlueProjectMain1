<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Product</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    /* Navbar */
    .navbar {
      background-color: #fff;
      display: flex;
      align-items: center;
      padding: 10px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .navbar img {
      height: 40px;
    }
    .back-btn {
      width: 30px;
      height: 30px;
      border: none;
      background: transparent;
      cursor: pointer;
      position: relative;
      margin-right: 12px;
    }
    .back-btn::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 8px;
      transform: translateY(-50%) rotate(45deg);
      width: 10px;
      height: 10px;
      border-left: 2px solid #333;
      border-bottom: 2px solid #333;
    }
    .back-btn:hover::before {
      border-color: #555;
    }

    .container {
      max-width: 500px;
      margin: 40px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 32px 28px 24px 28px;
    }
    h2 {
      margin-top: 0;
      color: #3d2b7d;
      text-align: center;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    label {
      font-weight: 500;
      margin-bottom: 4px;
    }
    input, select, textarea {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .btn-submit {
      background: #3d2b7d;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 0;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.2s;
    }
    .btn-submit:hover {
      background: #2a1e5c;
    }
    .photo-preview {
      margin-top: 6px;
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ccc;
      display: none;
    }
    .note {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
      display:none;
    }
    .note.error { color:#b91c1c; display:block; }
    .note.ok { color:#374151; display:block; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <button class="back-btn" onclick="history.back()" title="Go Back"></button>
    <img src="logo.jpg" alt="Logo">
  </div>

  <div class="container">
    <h2>Add Product</h2>
    <form id="addProductForm">
      <div>
        <label for="productId">Product ID</label>
        <input type="text" id="productId" name="productId" required readonly>
      </div>
      <div>
        <label for="name">Name</label>
        <input type="text" id="name" name="name" required>
      </div>
      <div>
        <label for="category">Category</label>
        <input type="text" id="category" name="category" required>
      </div>
      <div>
        <label for="details">Details</label>
        <textarea id="details" name="details" required></textarea>
      </div>
      <div>
        <label for="mrp">MRP</label>
        <input type="number" id="mrp" name="mrp" min="0" required>
      </div>
      <div>
        <label for="offer">Offer Price</label>
        <input type="number" id="offer" name="offer" min="0" required>
      </div>
      <div>
        <label for="security">Security Deposit Required?</label>
        <select id="security" name="security" required>
          <option value="Applicable">Applicable</option>
          <option value="Not Applicable">Not Applicable</option>
        </select>
      </div>
      <div>
        <label for="photo">Photo (max 200 KB)</label>
        <input type="file" id="photo" name="photo" accept="image/*" required>
        <img id="photoPreview" class="photo-preview" alt="Photo Preview">
        <div id="photoNote" class="note"></div>
      </div>
      <button type="submit" class="btn-submit">Add Product</button>
    </form>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../firebase.js"></script>
  <script>
    const MAX_IMAGE_BYTES = 200 * 1024;
    const photoInput   = document.getElementById('photo');
    const photoPreview = document.getElementById('photoPreview');
    const photoNote    = document.getElementById('photoNote');
    let photoBase64 = '';

    function formatBytes(bytes){
      if (!bytes && bytes !== 0) return '';
      return (bytes/1024).toFixed(1) + ' KB';
    }

    function resetPhotoUI(msg='', isError=false){
      photoInput.value = '';
      photoPreview.src = '';
      photoPreview.style.display = 'none';
      photoBase64 = '';
      if (msg){
        photoNote.textContent = msg;
        photoNote.className = 'note ' + (isError ? 'error' : 'ok');
      } else {
        photoNote.textContent = '';
        photoNote.className = 'note';
      }
    }

    photoInput.addEventListener('change', function() {
      const file = this.files[0];
      if (!file){ resetPhotoUI(); return; }
      if (!file.type.startsWith('image/')){
        resetPhotoUI('Please select an image file.', true);
        return;
      }
      if (file.size > MAX_IMAGE_BYTES){
        resetPhotoUI(`Selected image is ${formatBytes(file.size)}. Max allowed is 200 KB.`, true);
        return;
      }
      photoNote.textContent = `Image size: ${formatBytes(file.size)} âœ“`;
      photoNote.className = 'note ok';
      const reader = new FileReader();
      reader.onload = function(e) {
        photoPreview.src = e.target.result;
        photoPreview.style.display = 'block';
        photoBase64 = e.target.result;
      };
      reader.onerror = function(){
        resetPhotoUI('Failed to read image. Please try another file.', true);
      };
      reader.readAsDataURL(file);
    });

    function approxBytesFromBase64(b64){
      if (!b64) return 0;
      const len = b64.length - (b64.startsWith('data:') ? b64.indexOf(',')+1 : 0);
      return Math.floor(len * 0.75);
    }
    function generateProductId() {
      return Math.floor(10000000 + Math.random() * 90000000).toString();
    }
    function setNewProductId() {
      document.getElementById('productId').value = generateProductId();
    }
    setNewProductId();

    document.getElementById('addProductForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!photoBase64){
        resetPhotoUI('Please select an image (max 200 KB).', true);
        return;
      }
      if (approxBytesFromBase64(photoBase64) > MAX_IMAGE_BYTES){
        resetPhotoUI(`Image exceeds 200 KB after processing.`, true);
        return;
      }
      const product = {
        productId: document.getElementById('productId').value,
        name: document.getElementById('name').value,
        category: document.getElementById('category').value,
        details: document.getElementById('details').value,
        mrp: Number(document.getElementById('mrp').value),
        offer: Number(document.getElementById('offer').value),
        security: document.getElementById('security').value,
        photo: photoBase64
      };
      try {
        await db.collection('products').add(product);
        alert('Product added to Firebase!');
        this.reset();
        resetPhotoUI('Ready for next product.');
        setNewProductId();logo.jpg
      } catch (err) {
        alert('Error adding product: ' + err.message);
      }
    });
  </script>
</body>
</html>
